stages:
  - lint
  - test
  - build

variables:
  NODE_ENV: "production"

cache:
  paths:
    - node_modules/

lint:
  image: node:18
  stage: lint
  script:
    - npm ci --legacy-peer-deps
    - npm run lint || true
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"

test:
  image: node:18
  stage: test
  script:
    - npm ci --legacy-peer-deps
    - npm run type-check
    - npm test -- --run
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"

# Build and push image to GitLab Container Registry. Runs on every push.
build_image:
  image: docker:24
  stage: build
  services:
    - name: docker:24-dind
      command: ["--mtu=1200"]
  variables:
    DOCKER_DRIVER: overlay2
  before_script:
    - docker info
    - echo "Logging into GitLab Container Registry"
    - docker login -u gitlab-ci-token -p "$CI_JOB_TOKEN" "$CI_REGISTRY"
  script:
    - export IMAGE="$CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA"
    - docker build --pull -t "$IMAGE" .
    - docker push "$IMAGE"
    - docker tag "$IMAGE" "$CI_REGISTRY_IMAGE:latest"
    - docker push "$CI_REGISTRY_IMAGE:latest"
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"

# Notes / Runner requirements:
# - This job requires a GitLab runner that supports Docker-in-Docker (dind) and is allowed to run privileged containers.
# - If your runner does NOT support dind, consider using Kaniko or the Docker Buildx executor on a runner with Docker installed.
# - The registry login uses the built-in $CI_JOB_TOKEN and $CI_REGISTRY variables provided by GitLab.
stages:
  - lint
  - test
  - build
  - mirror
  - deploy

# NOTE: This is a template. You MUST configure the GitLab CI variables described below
# before enabling deploy/mirror jobs.

variables:
  # Optional: npm cache folder to speed up installs
  NODE_ENV: "production"

cache:
  paths:
    - node_modules/

lint:
  image: node:18
  stage: lint
  script:
    - npm ci --legacy-peer-deps
    - npm run lint || true
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"

test:
  image: node:18
  stage: test
  script:
    - npm ci --legacy-peer-deps
    - npm run type-check
    - npm test -- --run
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"

# Build and push image to GitLab Container Registry. Runs on every push.
build_image:
  image: docker:24
  stage: build
  services:
    - name: docker:24-dind
      command: ["--mtu=1200"]
  variables:
    DOCKER_DRIVER: overlay2
  before_script:
    - docker info
    - echo "Logging into GitLab Container Registry"
    - docker login -u gitlab-ci-token -p "$CI_JOB_TOKEN" "$CI_REGISTRY"
  script:
    - export IMAGE="$CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA"
    - docker build --pull -t "$IMAGE" .
    - docker push "$IMAGE"
    - docker tag "$IMAGE" "$CI_REGISTRY_IMAGE:latest"
    - docker push "$CI_REGISTRY_IMAGE:latest"
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"

# Mirror to Google Artifact Registry (optional). Runs only when MIRROR_TO_GAR is set to "true".
mirror_to_gar:
  image: google/cloud-sdk:slim
  stage: mirror
  variables:
    # Path to gcloud key will be created from the CI variable below
    GCLOUD_KEY_FILE: "/tmp/gcloud-key.json"
  before_script:
    - echo "Preparing GCP auth"
    - if [ -z "$GCP_SERVICE_ACCOUNT_KEY" ]; then echo "GCP_SERVICE_ACCOUNT_KEY is not set"; exit 1; fi
    - echo "$GCP_SERVICE_ACCOUNT_KEY" | base64 -d > "$GCLOUD_KEY_FILE"
    - gcloud auth activate-service-account --key-file="$GCLOUD_KEY_FILE"
    - gcloud config set project "$GCP_PROJECT_ID"
    - gcloud auth configure-docker --quiet
  script:
    - if [ -z "$ARTIFACT_REGISTRY_HOST" ]; then echo "ARTIFACT_REGISTRY_HOST is not set (e.g. us-docker.pkg.dev)"; exit 1; fi
    - export SRC_IMAGE="$CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA"
    - docker pull "$SRC_IMAGE"
    - export DEST_IMAGE="$ARTIFACT_REGISTRY_HOST/$GCP_PROJECT_ID/$ARTIFACT_REGISTRY_REPOSITORY/$CI_PROJECT_NAME:$CI_COMMIT_SHORT_SHA"
    - docker tag "$SRC_IMAGE" "$DEST_IMAGE"
    - docker push "$DEST_IMAGE"
    - # Optionally tag latest
    - export DEST_LATEST="$ARTIFACT_REGISTRY_HOST/$GCP_PROJECT_ID/$ARTIFACT_REGISTRY_REPOSITORY/$CI_PROJECT_NAME:latest"
    - docker tag "$CI_REGISTRY_IMAGE:latest" "$DEST_LATEST" || true
    - docker push "$DEST_LATEST" || true
  rules:
    - if: '$MIRROR_TO_GAR == "true"'

# Deploy to Cloud Run. Runs only on `main` branch and when GCP vars are set.
deploy_cloud_run:
  image: google/cloud-sdk:slim
  stage: deploy
  before_script:
    - if [ -z "$GCP_SERVICE_ACCOUNT_KEY" ]; then echo "GCP_SERVICE_ACCOUNT_KEY is not set"; exit 1; fi
    - echo "$GCP_SERVICE_ACCOUNT_KEY" | base64 -d > /tmp/gcloud-key.json
    - gcloud auth activate-service-account --key-file=/tmp/gcloud-key.json
    - gcloud config set project "$GCP_PROJECT_ID"
  script:
    - if [ -z "$CLOUD_RUN_SERVICE" ]; then echo "CLOUD_RUN_SERVICE not set"; exit 1; fi
    - if [ -z "$GCP_REGION" ]; then echo "GCP_REGION not set"; exit 1; fi
    - export IMAGE="$CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA"
    - gcloud run deploy "$CLOUD_RUN_SERVICE" --image="$IMAGE" --region="$GCP_REGION" --platform=managed --quiet
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

# End of pipeline

## Required CI variables (set these in GitLab project settings > CI/CD > Variables):
# - GCP_SERVICE_ACCOUNT_KEY: base64-encoded service account JSON with permissions for Artifact Registry & Cloud Run
# - GCP_PROJECT_ID: your GCP project id
# - GCP_REGION: region for Cloud Run and Artifact Registry (e.g. us-central1)
# - ARTIFACT_REGISTRY_HOST: (e.g. us-docker.pkg.dev) â€” required if MIRROR_TO_GAR == "true"
# - ARTIFACT_REGISTRY_REPOSITORY: Artifact Registry repository name
# - MIRROR_TO_GAR: set to "true" to enable mirroring job
stages:
  - build
  - deploy

variables:
  GCP_PROJECT_ID: "edifyai-2737f"
  GCP_REGION: "asia-east1"
  SERVICE_NAME: "gen-ed-demo"
  # Use GitLab's integration variables if available, otherwise fall back to manual values
  ARTIFACT_REGISTRY_PROJECT_ID: "${GOOGLE_ARTIFACT_REGISTRY_PROJECT_ID:-$GCP_PROJECT_ID}"
  ARTIFACT_REGISTRY_REPOSITORY: "${GOOGLE_ARTIFACT_REGISTRY_REPOSITORY_NAME:-gen-ed-repo}"
  ARTIFACT_REGISTRY_LOCATION: "${GOOGLE_ARTIFACT_REGISTRY_REPOSITORY_LOCATION:-$GCP_REGION}"
  IMAGE: "$ARTIFACT_REGISTRY_LOCATION-docker.pkg.dev/$ARTIFACT_REGISTRY_PROJECT_ID/$ARTIFACT_REGISTRY_REPOSITORY/gen-ed-app:$CI_COMMIT_SHORT_SHA"
  IMAGE_LATEST: "$ARTIFACT_REGISTRY_LOCATION-docker.pkg.dev/$ARTIFACT_REGISTRY_PROJECT_ID/$ARTIFACT_REGISTRY_REPOSITORY/gen-ed-app:latest"

mirror_to_artifact_registry:
  stage: build
  image: gcr.io/google.com/cloudsdktool/cloud-sdk:slim
  services:
    - name: docker:dind
      alias: docker
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  before_script:
    # Install docker client (dind provides daemon)
    - apt-get update && apt-get install -y --no-install-recommends ca-certificates gnupg lsb-release curl docker.io
    - echo "Configured DOCKER_HOST=$DOCKER_HOST"
    # Write service account key (supports raw JSON or base64-encoded value)
    - 'echo "Writing GCP service account key to file..."'
    - 'echo "$GCP_SERVICE_ACCOUNT_KEY" | base64 --decode > ${CI_PROJECT_DIR}/gcloud-key.json 2>/dev/null || echo "$GCP_SERVICE_ACCOUNT_KEY" > ${CI_PROJECT_DIR}/gcloud-key.json'
    - gcloud auth activate-service-account --key-file=${CI_PROJECT_DIR}/gcloud-key.json
    - gcloud config set project $GCP_PROJECT_ID
    - gcloud auth configure-docker $ARTIFACT_REGISTRY_LOCATION-docker.pkg.dev --quiet
  script:
    - echo "Pulling image from GitLab Container Registry: $CI_REGISTRY_IMAGE:latest"
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
    - docker pull $CI_REGISTRY_IMAGE:latest
    - echo "Tagging for Artifact Registry: $IMAGE_LATEST"
    - docker tag $CI_REGISTRY_IMAGE:latest $IMAGE_LATEST
    - echo "Pushing to Artifact Registry: $IMAGE_LATEST"
    - docker push $IMAGE_LATEST
    - echo "Image successfully mirrored to Artifact Registry"
  only:
    - main

deploy:
  stage: deploy
  image: gcr.io/google.com/cloudsdktool/cloud-sdk:slim
  before_script:
    - 'gcloud config set project $GCP_PROJECT_ID'
  script:
    - 'echo "Deploying $SERVICE_NAME to Cloud Run"'
    - 'gcloud run deploy $SERVICE_NAME --image=$IMAGE_LATEST --region=$GCP_REGION --platform=managed --allow-unauthenticated --port=3000 --project=$GCP_PROJECT_ID'
  only:
    - main
  needs:
    - build